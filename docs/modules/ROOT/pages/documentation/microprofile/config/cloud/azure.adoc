# Azure Cloud Config Source

The Azure cloud config source takes configuration properties from Azure Key Vault Secrets.

## Register Azure AD Application and Create Service Principle

If you haven't already you will need to register an Azure Active Directory (Azure AD) application and create a service principal. So the Microsoft identity platform can provide authentication and authorisation services. You can use the Azure portal to register your application and create a service principle.

Once you have signed in to your Azure portal, search for Azure Active Directory and select it, under Manage section select App registrations and final click on New registration.

NOTE: If you have access to multiple tenants and what to select a specific tenant to register your application, use the Directory + subscription filter in the top menu.

image:microprofile/config/cloud/azure/application-registration.png[Application Registration]

Then provide a name for your application.  Select the appropriate account types and select Register to complete your application registration. Once the application registration is completed, the service principal is automatically created in your home tenant. 

image:microprofile/config/cloud/azure/application-registration-configuration.png[Application Registration Configuration]

## Application API Permissions
You will need to allow your application full access to the Azure Key Vault service to retrieve the secrets stored within it. To do this you will need to configure your application's API permissions. You can learn more about permissions and consent https://docs.microsoft.com/en-gb/azure/active-directory/develop/v2-permissions-and-consent[here]. 

Once you have registered your application and created a service principle. Select your application, under Manage section select API permissions, select Add permission, select Azure Key Vault for list of Microsoft APIs, then under types of permission select Delegated permissions, under Permission select _user_impersonation_ and finally select Add permissions.   

image:microprofile/config/cloud/azure/API-permissions.png[API Permissions]

## Add Credentials

Credentials allow your application to authenticate as itself. Currently Azure supports two options as credentials: client secrets (a string) and certificates (public key). Currently, Payara only supports certificate as a credential as it provides a higher level of assurance than a client secret.

To upload for own certificate for authentication. Select your application, under Manage section select Certificates & secrets, select Upload certificate, select the certificate you would like to upload and select Add. Once the certificate is successfully uploaded it should generate a Thumbprint, this will be required when we configure the Azure Config Source.

image:microprofile/config/cloud/azure/certificate-upload.png[Certificate Upload]

## Create a Key Vault

To securely store your secrets you will need to create a key vault. To create a key valut using the Azure portal, search for key vaults and select it, select Add and provide relvant information on the Create key vault page and finally select Review + create.  

NOTE: Although key vault allows storing of keys, secrets, and certificates, Azure Config Source currently only support secrets.

image:microprofile/config/cloud/azure/key-vault-creation.png[Key Vault Creation]

You can see from the above diagram I have only configured the Basic section and other section such as Access policy and Networking has been left to their defaults. You can confguire these section yourslef to fit your requirments.

### Configure access policies on Key Vault

To give an application access to secrets in a key vault you will need to add the application to the key vault's acess policies. To do this using a Azure portal, navigate to your key vault, select Access policies, select Add Access Policy, under Add access policy page for *Configure from template* select Secret Management as we don't require others, select the service principal you created previously, then select Add and finally select Save to commit your changes. 

image:microprofile/config/cloud/azure/access-policy-configuration.png[Access Policy Configuration]

### Add a Secret to Key Vault

To add a secert to the key vault, select the key vault you want to add your secert, under Settings section select Secrets, then select Generate/Import, provide relvant information on the Create a secret page and finally select Create. 

image:microprofile/config/cloud/azure/secret-creation.png[Secret Creation]

[[configuration]]
## Configuration

You can configure Azure Secrets either via the admin console or the _asadmin_ utility. You'll need the key vault name you created in the pervious section, tenant ID and client ID of you application you crerated in the pervious section, your private key file and thumbprint generated by your application after you uploaded your certificate.  

NOTE: Your private key file will be copied into the Payara Server config/ directory.

### From the Admin Console

To configure the config source from the admin console, go to `Configs` -> `your-config` -> `MicroProfile` -> `Config` -> `Azure Secrets`.

image:microprofile/config/cloud/azure/admin-console-config.png[Payara Server Administration Console configuration route]

From here you can pass the name of the key vault, tenant ID and client ID of the application, absolute path to the private key file and thumbprint of the certificate. You can also decide whether to apply these changes dynamically or on the next server restart. If the config source is enabled or disabled dynamically it will take effect across the server immediately.

### From the Command Line

To configure the Azure Config Source from the command line, use the `set-azure-config-source-configuration` asadmin command, specifying the required parameters like this:

[source, shell]
----
asadmin> set-azure-config-source-configuration --dynamic true --enabled true --keyVaultName demo-secret-key-vault --tenantID 22b3bb26-e046-42df-9c96-65dbd72c1c81 --clientID 22b3bb26-e046-42df-9c96-65dbd72c1c81 --thumbprint 84E05C1D98BCE3A5421D225B140B36E86A3D5534 --privateKeyPath path/to/privatekey.pem
----

You can use the `--enabled` and `--dynamic` options to enable or disable the Azure Config Source on demand.

Also, you can retrieve the current configuration for the Azure Config Source using the `get-azure-config-source-configuration` asadmin command like this:

[source, shell]
----
asadmin> get-azure-config-source-configuration

Enabled  Tenant ID                             Client ID                             Key VaultName          Private Key Path  Thumbprint
true     22b3bb26-e046-42df-9c96-65dbd72c1c81  22b3bb26-e046-42df-9c96-65dbd72c1c81  demo-secret-key-vault  path/to/privatekey.pem           84E05C1D98BCE3A5421D225B140B36E86A3D5534
----

## Usage

Provided all of the above sections are configured correctly, the secrets can be injected into any applicable MicroProfile Config injection point as with any other Config Source. The secrets can also be fetched, created and deleted from the `asadmin` utility.

To fetch a secret from a Key Vault:

[source, shell]
----
asadmin> get-config-property --source cloud --sourceName azure --propertyName demo-secret
demo-secret-value
----

To create or change a secret in a Key Vault:

[source, shell]
----
asadmin> set-config-property --source cloud --sourceName azure --propertyName mysecret --propertyValue secretvalue
----

To delete a secret from a Key Vault:

[source, shell]
----
asadmin> delete-config-property --source cloud --sourceName azure --propertyName mysecret
----